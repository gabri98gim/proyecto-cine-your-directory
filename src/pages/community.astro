---
import Layout from '../layouts/Layout.astro';
import Navbar from '../components/Navbar.astro';

// 1. DEFINICI√ìN DE TIPOS
interface TMDBMovie {
    id: number;
    title: string;
    poster_path: string | null;
}

interface Review {
    id: number;
    movieTitle: string;
    moviePoster: string | null;
    user: { name: string; avatar: string };
    comment: string;
    rating: string;
    timeAgo: string;
}

// 2. CONFIGURACI√ìN (CORREGIDO AQU√ç üëá)
// Usamos PUBLIC_TMDB_API_KEY porque as√≠ lo llamaste en tu archivo .env
const API_KEY = import.meta.env.PUBLIC_TMDB_API_KEY; 
const IMAGE_BASE = "https://image.tmdb.org/t/p/w200";

// Datos Ficticios
const FAKE_USERS = [
    { name: "Alex Cinefilo", avatar: "https://i.pravatar.cc/150?img=11" },
    { name: "Sofia Movies", avatar: "https://i.pravatar.cc/150?img=5" },
    { name: "Retro Dave", avatar: "https://i.pravatar.cc/150?img=3" },
    { name: "Ana Critic", avatar: "https://i.pravatar.cc/150?img=9" },
    { name: "John Doe", avatar: "https://i.pravatar.cc/150?img=13" },
    { name: "Maria Screen", avatar: "https://i.pravatar.cc/150?img=24" },
];

const FAKE_COMMENTS = [
    "¬°Simplemente espectacular! La fotograf√≠a es de otro nivel.",
    "No me convenci√≥ el final, pero las actuaciones fueron s√≥lidas.",
    "La mejor pel√≠cula que he visto este a√±o. 100% recomendada.",
    "Un poco lenta al principio, pero el segundo acto recompensa la espera.",
    "Esperaba m√°s del director, me sent√≠ un poco decepcionado.",
    "¬°Una obra maestra instant√°nea! Necesito verla de nuevo.",
    "Efectos visuales incre√≠bles, aunque el guion flojea un poco.",
    "Me hizo llorar como un beb√©. Muy emotiva."
];

// 3. L√ìGICA DEL SERVIDOR
let communityReviews: Review[] = [];
let error = null;

if (API_KEY) {
    try {
        const response = await fetch(`https://api.themoviedb.org/3/trending/movie/day?api_key=${API_KEY}&language=es-ES`);
        
        if (!response.ok) throw new Error("Error conectando con TMDB");

        const data = await response.json();
        
        if (data.results) {
            communityReviews = data.results.slice(0, 12).map((movie: TMDBMovie) => {
                const randomUser = FAKE_USERS[Math.floor(Math.random() * FAKE_USERS.length)];
                const randomComment = FAKE_COMMENTS[Math.floor(Math.random() * FAKE_COMMENTS.length)];
                const randomRating = (Math.random() * (5.0 - 3.0) + 3.0).toFixed(1);
                const randomHours = Math.floor(Math.random() * 23) + 1;

                return {
                    id: movie.id,
                    movieTitle: movie.title,
                    moviePoster: movie.poster_path ? `${IMAGE_BASE}${movie.poster_path}` : null,
                    user: randomUser,
                    comment: randomComment,
                    rating: randomRating,
                    timeAgo: `hace ${randomHours} horas`
                };
            });
        }
    } catch (e) {
        console.error("Error fetching TMDB:", e);
        error = "Error al cargar datos. Verifica tu conexi√≥n.";
    }
} else {
    error = "Falta la API Key en el archivo .env (Revisa que se llame PUBLIC_TMDB_API_KEY).";
}
---

<Layout title="Comunidad | Your Directory">
    <Navbar />
    <div class="container mx-auto py-12 px-4">
        
        <div class="text-center mb-16">
            <h1 class="text-4xl md:text-5xl font-bold text-white mb-4">
                Actividad de la <span class="text-accent-purple-light">Comunidad</span>
            </h1>
            <p class="text-gray-400 max-w-2xl mx-auto">
                Descubre qu√© est√°n viendo y opinando otros miembros.
            </p>
        </div>

        {error ? (
            <div class="bg-red-900/50 border border-red-500 text-red-200 p-6 rounded-lg text-center max-w-2xl mx-auto">
                <p class="font-bold text-xl mb-2">‚ö†Ô∏è Ups, algo fall√≥</p>
                <p>{error}</p>
                {!API_KEY && (
                    <p class="text-sm mt-4 text-red-300">
                        Tu archivo .env tiene <code>PUBLIC_TMDB_API_KEY</code>, pero el c√≥digo busca otra cosa.<br/>
                        ¬°Con este c√≥digo corregido deber√≠a funcionar!
                    </p>
                )}
            </div>
        ) : (
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                {communityReviews.map((review: Review) => (
                    <article class="bg-gray-800 rounded-xl p-6 shadow-lg border border-gray-700 hover:border-accent-purple-dark transition-colors duration-300 flex flex-col">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center space-x-3">
                                <img src={review.user.avatar} alt={review.user.name} class="w-10 h-10 rounded-full border-2 border-accent-purple-light"/>
                                <div>
                                    <h3 class="text-sm font-bold text-white">{review.user.name}</h3>
                                    <span class="text-xs text-gray-500">{review.timeAgo}</span>
                                </div>
                            </div>
                            <div class="flex items-center text-yellow-400 text-sm font-bold">
                                <svg class="w-4 h-4 mr-1 fill-current" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>
                                {review.rating}
                            </div>
                        </div>
                        <p class="text-gray-300 text-sm mb-4 italic">"{review.comment}"</p>
                        <div class="mt-auto pt-4 border-t border-gray-700 flex items-center space-x-4">
                            {review.moviePoster ? (
                                <img src={review.moviePoster} alt={review.movieTitle} class="w-12 h-18 object-cover rounded shadow-md"/>
                            ) : (
                                <div class="w-12 h-18 bg-gray-700 rounded flex items-center justify-center text-xs">Sin img</div>
                            )}
                            <div class="flex-1">
                                <p class="text-xs text-gray-500 uppercase tracking-wide">Vio la pel√≠cula</p>
                                <h4 class="text-white font-semibold leading-tight hover:text-accent-purple-light cursor-pointer transition">
                                    {review.movieTitle}
                                </h4>
                            </div>
                        </div>
                    </article>
                ))}
            </div>
        )}
    </div>
</Layout>